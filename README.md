# Автоматизированное развёртывание микросервиса с метриками в Yandex Cloud

Данный проект представляет собой полностью автоматизированный pipeline для развёртывания микросервиса, собирающего системные метрики, в облачной инфраструктуре Yandex Cloud. Вся цепочка действий — от создания виртуальной машины до запуска работающего сервиса, экспортирующего данные в формате Prometheus, — выполняется одной командой `terraform apply`. Пользователю не требуется вручную подключаться к серверу, копировать файлы, устанавливать зависимости или запускать дополнительные скрипты. Всё происходит последовательно, прозрачно и воспроизводимо.

Проект состоит из двух основных компонентов: Terraform и Ansible. Terraform отвечает за создание и настройку облачной инфраструктуры, а Ansible — за конфигурацию программного обеспечения и развёртывание самого микросервиса. Ключевая особенность архитектуры заключается в том, что Ansible-плейбук запускается непосредственно из Terraform-файла с помощью provisioner `local-exec`, что позволяет объединить управление инфраструктурой и конфигурацией в единый рабочий процесс.

## Что делает микросервис

Микросервис — это небольшая программа на языке Python, использующая библиотеку `prometheus_client`. Она запускает встроенный HTTP-сервер на порту 8080 и предоставляет эндпоинт `/metrics`, по которому можно получить четыре ключевые метрики:

- **HOST_TYPE** — определяет тип хоста, на котором запущен сервис. Если микросервис работает внутри контейнера Docker, метрика принимает значение `container`. Если он запущен на виртуальной машине (например, в Yandex Cloud), значение будет `vm`. В остальных случаях — `physical`.
- **HTTP_REQUESTS** — счётчик количества HTTP-запросов, отправленных к эндпоинту `/metrics`.
- **UPTIME** — время работы микросервиса в секундах с момента его запуска.
- **ERRORS** — количество ошибок, возникших при работе сервиса. В текущей реализации эта метрика всегда равна нулю, но архитектура позволяет легко расширить логику для учёта реальных ошибок.

Эти метрики могут быть собраны любой системой мониторинга, поддерживающей формат Prometheus, например, самим Prometheus или Grafana.

## Как работает Terraform

Terraform-конфигурация находится в одном файле `main.tf` и выполняет следующие действия:

1. Подключается к Yandex Cloud с использованием JSON-ключа сервисного аккаунта, который должен быть размещён в каталоге `terraform/key.json`.
2. Создаёт загрузочный диск размером 30 ГБ на базе образа AlmaLinux 9.
3. Создаёт виртуальную машину с 4 ядрами CPU и 4 ГБ оперативной памяти.
4. Настраивает сеть: использует существующую VPC-сеть `default` и создаёт новую подсеть `subnet1` с CIDR-блоком `192.168.10.0/24`.
5. Настраивает сетевой интерфейс с публичным IP-адресом (NAT) для доступа из интернета.
6. Добавляет SSH-ключ пользователя `almaLinux` на виртуальную машину, чтобы обеспечить доступ по протоколу SSH.
7. После успешного создания виртуальной машины запускает Ansible-плейбук с помощью ресурса `null_resource` и provisioner `local-exec`.

Важно отметить, что Terraform передаёт публичный IP-адрес виртуальной машины напрямую в команду запуска Ansible через параметр `-i '<IP>,'`, что исключает необходимость в отдельном файле inventory. Кроме того, используется триггер на основе хеша содержимого плейбука, что гарантирует повторный запуск Ansible при любом изменении в коде плейбука.

## Как работает Ansible

Ansible-плейбук `playbook.yml` запускается сразу после создания виртуальной машины. Он выполняется от имени пользователя `almaLinux` с повышением привилегий до root через sudo. Плейбук подключает переменные из файла `allvars.yml` и применяет две роли: `docker` и `delivery-metrics`.

Роль `docker` отвечает за установку Docker Engine. Она автоматически определяет тип операционной системы (Debian/Ubuntu или RedHat-подобная, включая AlmaLinux) и выполняет соответствующие действия: устанавливает необходимые зависимости, добавляет официальный репозиторий Docker, устанавливает пакет `docker-ce`, запускает службу и добавляет пользователя в группу `docker` для управления контейнерами без использования sudo.

Роль `delivery-metrics` отвечает за развёртывание самого микросервиса. Она проверяет значение переменной `deploy_mode` из файла `allvars.yml` и выбирает один из двух сценариев:

- Если `deploy_mode == "systemd"`, роль устанавливает Python 3 и pip, создаёт директорию `/opt/microservice`, копирует туда файл `app.py`, устанавливает библиотеку `prometheus_client` (через системный пакетный менеджер или pip в зависимости от ОС), создаёт unit-файл systemd из шаблона `microservice.service.j2`, перезагружает демон systemd и запускает службу с настройкой автозагрузки.
- Если `deploy_mode == "docker"`, роль стягивает образ `pavleqp/microservice:latest` из Docker Hub и запускает контейнер с именем `microservice-container`. Контейнер настраивается на автоматический перезапуск, пробрасывает порт 8080 контейнера на порт 8081 хоста и устанавливает переменную окружения `HOST_TYPE_OVERRIDE=container`, чтобы микросервис корректно определял свой тип хоста.

После завершения работы Ansible микросервис становится доступен по адресу `http://<публичный_IP_ВМ>:8080/metrics` (в случае systemd) или `http://<публичный_IP_ВМ>:8081/metrics` (в случае Docker). 

## Как использовать проект

Перед запуском необходимо выполнить несколько подготовительных шагов:

1. Создайте сервисный аккаунт в Yandex Cloud с необходимыми правами (cloud.compute.admin, vpc.admin и др.) и скачайте JSON-ключ. Поместите этот файл в каталог `terraform/` под именем `key.json`.
2. Убедитесь, что у вас есть SSH-ключ. По умолчанию используется ключ `~/.ssh/id_ed25519`. Если у вас другой ключ, обновите путь в `main.tf`.
3. Замените значение `folder_id` в `main.tf` на идентификатор вашей папки в Yandex Cloud.
4. Откройте файл `ansible/allvars.yml` и установите переменную `deploy_mode` в одно из значений: `systemd` или `docker`.
5. Если вы выбрали режим `docker`, убедитесь, что образ `pavleqp/microservice:latest` существует в Docker Hub и является публичным.

После подготовки перейдите в каталог `terraform` и выполните команды:

```bash
terraform init
terraform apply
```
Подтвердите создание ресурсов, введя yes. Terraform создаст инфраструктуру и автоматически запустит Ansible. По завершении вы увидите вывод с внутренним и внешним IP-адресами виртуальной машины. Метрики будут доступны по указанному адресу.

## Структура проекта

Проект организован в следующую структуру каталогов:

  - terraform/ — содержит Terraform-конфигурацию (main.tf) и JSON-ключ сервисного аккаунта (key.json).
  - ansible/ — содержит Ansible-плейбук (playbook.yml), файл переменных (allvars.yml) и каталог ролей (roles/).
  - roles/docker/ — роль для установки Docker Engine.
  - roles/delivery-metrics/ — роль для развёртывания микросервиса в выбранном режиме.
  - roles/delivery-metrics/files/ — содержит исходный код микросервиса (app.py).
